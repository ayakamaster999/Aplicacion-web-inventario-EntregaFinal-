name: Docker Compose CI with Code Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      # ==================== Checkout ====================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==================== Environment Setup ====================
      - name: Set COMPOSE_FILE path
        run: echo "COMPOSE_FILE=aplicacion web- inventario/docker-compose.yml" >> $GITHUB_ENV

      - name: Display workflow context
        run: |
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Branch: $GITHUB_REF"
          echo "Actor: $GITHUB_ACTOR"
          echo "Compose file: $COMPOSE_FILE"

      # ==================== Node.js Setup ====================
      - name: Setup Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      # ==================== Backend: Install Dependencies ====================
      - name: Install backend dependencies
        working-directory: aplicacion web- inventario/backend
        run: |
          echo "Installing backend dependencies..."
          npm install
          echo "Dependencies installed successfully"

      # ==================== Backend: Run Tests with Coverage ====================
      - name: Run backend tests with coverage
        working-directory: aplicacion web- inventario/backend
        run: |
          echo "Running tests with coverage..."
          npm run test:coverage
        continue-on-error: true

      # ==================== Backend: Run Build (if available) ====================
      - name: Run backend build (if available)
        working-directory: aplicacion web- inventario/backend
        run: |
          if npm run | grep -q "build"; then
            echo "Running build script..."
            npm run build
          else
            echo "No build script found, skipping"
          fi
        continue-on-error: true

      # ==================== Code Coverage Upload to Codecov ====================
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./aplicacion\ web-\ inventario/backend/coverage/lcov.info
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      # ==================== Docker Compose: Clean & Build ====================
      - name: Docker compose down (clean previous deployment)
        run: |
          docker compose -f "$COMPOSE_FILE" down || true
        continue-on-error: true

      - name: Docker compose pull latest images
        run: |
          docker compose -f "$COMPOSE_FILE" pull

      - name: Docker compose up (build and run services)
        run: |
          docker compose -f "$COMPOSE_FILE" up -d --build
        continue-on-error: true

      # ==================== Verify Services ====================
      - name: Verify services are running
        run: |
          echo "Checking running containers..."
          docker ps
          echo "Container logs for debugging (if any issues)..."
          docker compose -f "$COMPOSE_FILE" logs || true
        continue-on-error: true
